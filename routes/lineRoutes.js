// lineRoutes.js
import express from 'express';
import lineService from '../services/lineService.js';
import { getConnection } from '../db.js';

const router = express.Router();

// ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LINE Login
router.get('/login-url/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á state ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô CSRF
    const state = Buffer.from(JSON.stringify({ userId, timestamp: Date.now() })).toString('base64');
    
    const loginUrl = lineService.generateLineLoginUrl(state);
    
    res.json({
      success: true,
      loginUrl: loginUrl,
      state: state
    });
  } catch (error) {
    console.error('Error generating LINE login URL:', error);
    res.status(500).json({
      success: false,
      message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LINE Login ‡πÑ‡∏î‡πâ'
    });
  }
});

// ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö LINE Login redirect ‡πÅ‡∏ö‡∏ö GET
// lineRoutes.js
router.get('/login-callback', async (req, res) => {
    try {
      const { code, state } = req.query;  // GET parameter
      if (!code || !state) return res.status(400).send('Missing code or state');
  
      const stateData = JSON.parse(Buffer.from(state, 'base64').toString());
      const { userId } = stateData;
  
      const tokenData = await lineService.exchangeCodeForToken(code);
      const profile = await lineService.getLineProfile(tokenData.access_token);
  
      await lineService.saveLineConnection(userId, {
        userId: profile.userId,
        displayName: profile.displayName,
        pictureUrl: profile.pictureUrl,
        accessToken: tokenData.access_token,
        refreshToken: tokenData.refresh_token
      });
  
      res.redirect(`${process.env.FRONTEND_URL}/line-callback?success=true&message=‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    } catch (error) {
      console.error(error);
      res.redirect(`${process.env.FRONTEND_URL}/line-callback?success=false&message=‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE`);
    }
  });
  
  

// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ callback ‡∏à‡∏≤‡∏Å LINE Login
router.post('/login-callback', async (req, res) => {
  try {
    const { code, state } = req.body;
    
    if (!code || !state) {
      return res.status(400).json({
        success: false,
        message: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      });
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö state
    let stateData;
    try {
      stateData = JSON.parse(Buffer.from(state, 'base64').toString());
    } catch (error) {
      return res.status(400).json({
        success: false,
        message: 'State ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
      });
    }
    
    const { userId } = stateData;
    
    // ‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô code ‡πÄ‡∏õ‡πá‡∏ô access token
    const tokenData = await lineService.exchangeCodeForToken(code);
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
    const profile = await lineService.getLineProfile(tokenData.access_token);
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    const lineData = {
      userId: profile.userId,
      displayName: profile.displayName,
      pictureUrl: profile.pictureUrl,
      accessToken: tokenData.access_token,
      refreshToken: tokenData.refresh_token
    };
    
    await lineService.saveLineConnection(userId, lineData);
    
    res.json({
      success: true,
      message: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      profile: {
        displayName: profile.displayName,
        pictureUrl: profile.pictureUrl
      }
    });
  } catch (error) {
    console.error('Error handling LINE callback:', error);
    res.status(500).json({
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE'
    });
  }
});

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE
router.get('/status/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    
    const connection = await lineService.getLineConnection(userId);
    
    if (connection) {
      res.json({
        success: true,
        connected: true,
        profile: {
          displayName: connection.line_display_name,
          pictureUrl: connection.line_picture_url,
          connectedAt: connection.connected_at
        }
      });
    } else {
      res.json({
        success: true,
        connected: false
      });
    }
  } catch (error) {
    console.error('Error checking LINE status:', error);
    res.status(500).json({
      success: false,
      message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ'
    });
  }
});

// ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE
router.post('/disconnect/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    
    await lineService.disconnectLine(userId);
    
    res.json({
      success: true,
      message: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
    });
  } catch (error) {
    console.error('Error disconnecting LINE:', error);
    res.status(500).json({
      success: false,
      message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ'
    });
  }
});

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö
router.post('/test-message/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const { message } = req.body;
    
    const connection = await lineService.getLineConnection(userId);
    
    if (!connection) {
      return res.status(400).json({
        success: false,
        message: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE'
      });
    }
    
    await lineService.sendMessage(connection.line_user_id, message || '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•');
    
    res.json({
      success: true,
      message: '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
    });
  } catch (error) {
    console.error('Error sending test message:', error);
    res.status(500).json({
      success: false,
      message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ'
    });
  }
});

// ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
router.get('/notifications/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const { page = 1, limit = 10 } = req.query;
    
    const connection = await getConnection();
    
    const offset = (page - 1) * limit;
    
    const [notifications] = await connection.query(
      `SELECT ln.*, a.first_name, a.last_name, a.hospital, a.appointment_date, a.appointment_time
       FROM line_notifications ln
       LEFT JOIN appointments a ON ln.appointment_id = a.id
       WHERE ln.user_id = ?
       ORDER BY ln.sent_at DESC
       LIMIT ? OFFSET ?`,
      [userId, parseInt(limit), offset]
    );
    
    const [countResult] = await connection.query(
      'SELECT COUNT(*) as total FROM line_notifications WHERE user_id = ?',
      [userId]
    );
    
    await connection.end();
    
    res.json({
      success: true,
      notifications: notifications,
      total: countResult[0].total,
      page: parseInt(page),
      limit: parseInt(limit)
    });
  } catch (error) {
    console.error('Error getting notifications:', error);
    res.status(500).json({
      success: false,
      message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ'
    });
  }
});

// LINE Webhook endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å LINE ‡πÅ‡∏•‡∏∞ LINE Login callback
router.post('/webhook', async (req, res) => {
  try {
    // Debug log (remove in production)
    if (process.env.NODE_ENV === 'development') {
      console.log('üì® Received LINE webhook:', JSON.stringify(req.body, null, 2));
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô LINE Login callback ‡∏´‡∏£‡∏∑‡∏≠ webhook
    if (req.body.code && req.body.state) {
      // LINE Login callback
      // Debug log (remove in production)
      if (process.env.NODE_ENV === 'development') {
        console.log('üîê Processing LINE Login callback');
      }
      
      const { code, state } = req.body;
      
      try {
        // ‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô code ‡πÄ‡∏õ‡πá‡∏ô access token
        const tokenData = await lineService.exchangeCodeForToken(code);
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        const profile = await lineService.getLineProfile(tokenData.access_token);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö state ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ userId
        let stateData;
        try {
          stateData = JSON.parse(Buffer.from(state, 'base64').toString());
        } catch (error) {
          console.error('Invalid state:', error);
          return res.status(400).json({ success: false, message: 'Invalid state' });
        }
        
        const { userId } = stateData;
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        const lineData = {
          userId: profile.userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl,
          accessToken: tokenData.access_token,
          refreshToken: tokenData.refresh_token
        };
        
        await lineService.saveLineConnection(userId, lineData);
        
        // Redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà frontend
        res.redirect(`${process.env.FRONTEND_URL || 'http://localhost:5174'}/line-callback?success=true&message=‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        
      } catch (error) {
        console.error('LINE Login callback error:', error);
        res.redirect(`${process.env.FRONTEND_URL || 'http://localhost:5174'}/line-callback?success=false&message=‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE`);
      }
      
    } else if (req.body.events) {
      // LINE Messaging API webhook
      // Debug log (remove in production)
      if (process.env.NODE_ENV === 'development') {
        console.log('üí¨ Processing LINE Messaging API webhook');
      }
      
      const events = req.body.events;
      
      if (!events || events.length === 0) {
        return res.status(200).json({ success: true, message: 'No events' });
      }
      
      for (const event of events) {
        if (event.type === 'message' && event.message.type === 'text') {
          // Debug log (remove in production)
          if (process.env.NODE_ENV === 'development') {
            console.log(`üìù Received message from ${event.source.userId}: ${event.message.text}`);
          }
          
          // ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          await lineService.sendMessage(event.source.userId, '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
        }
      }
      
      res.status(200).json({ success: true, message: 'Webhook processed' });
    } else {
      res.status(200).json({ success: true, message: 'Unknown webhook type' });
    }
    
  } catch (error) {
    console.error('‚ùå LINE webhook error:', error);
    res.status(500).json({ success: false, message: 'Webhook error' });
  }
});

// LINE Webhook endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (GET method)
router.get('/webhook', (req, res) => {
  res.status(200).json({ 
    success: true, 
    message: 'LINE Webhook endpoint is working',
    timestamp: new Date().toISOString()
  });
});

export default router;
